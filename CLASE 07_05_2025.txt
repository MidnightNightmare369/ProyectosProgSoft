--CLASE 7_05_2025 -- CONTINUACION Y USO DE TRIGGERS 
--CREAR UN TRIGGER QUE PERMITA CONTROLAR EL ESTADO DE UNA TABLA 

IF NOT EXISTS (SELECT * FROM sys.sysobjects 
WHERE name = 'ALMACEN' AND xtype = 'U')
BEGIN 
CREATE TABLE SUPERMERCADO (
ID_ALMACEN INT PRIMARY KEY NOT NULL,
ESTADO VARCHAR (50) DEFAULT 'INICIO',
FECHA_CAMBIO_ESTADO DATETIME)
END;

SELECT * FROM SUPERMERCADO

CREATE TABLE CAMBIO_ESTADO(
ID_CAMBIOEST INT PRIMARY KEY NOT NULL,
ID_ALMACEN INT,
FECHA_2 DATETIME DEFAULT GETDATE()
);

CREATE TRIGGER CAMBIO_DE_ESTADO_POR_FECHA
ON SUPERMERCADO
AFTER UPDATE 
AS 
IF UPDATE (ESTADO)
	BEGIN 
		UPDATE SUPERMERCADO SET FECHA_CAMBIO_ESTADO = GETDATE()
		WHERE ID_ALMACEN = (SELECT ID_ALMACEN FROM inserted)

INSERT INTO CAMBIO_ESTADO (ID_ALMACEN, ESTADO)
SELECT ID_ALMACEN, ESTADO FROM deleted WHERE ID_ALMACEN = deleted.ID_ALMACEN
END;


--DESARROLLAR UN TRIGGER QUE PERMITA CAMBIAR EN UN CAMPO EL ESTADO O CANTIDAD DADA
--EJEMPLO INCULIR UNA COLUMNA CANTIDAD, LLEVARLE UN VALOR Y LUEGO QUE UN TRIGGER LO DIVIDA A LA MITAD 

SELECT * FROM PRODUCTO

ALTER TABLE PRODUCTO
UPDATE PRODUCTO SET CANTIDAD = 12 WHERE ID_PRODUCTO = 1
UPDATE PRODUCTO SET CANTIDAD = 24 WHERE ID_PRODUCTO = 2
UPDATE PRODUCTO SET CANTIDAD = 36 WHERE ID_PRODUCTO = 3

CREATE TRIGGER CAMBIO_CANTIDAD 
ON PRODUCTO
AFTER UPDATE 
AS 
BEGIN 
	IF UPDATE (CANTIDAD)
	BEGIN 
		DECLARE @NUEVA_CANTIDAD INT, @IDPRODUCTO INT 
		SELECT @NUEVA_CANTIDAD =  CANTIDAD-(CANTIDAD/2) FROM PRODUCTO WHERE IDPRODUCTO = @IDPRODUCTO 

		PRINT 'SE CAMBIO LA CANTIDAD DEL PRODUCTO: ' + CAST (@NUEVA_CANTIDAD AS VARCHAR)
	END
END
GO

SELECT * FROM PRODUCTO

ALTER TABLE PRODUCTO
UPDATE PRODUCTO SET CANTIDAD = 12 WHERE ID_PRODUCTO = 1
UPDATE PRODUCTO SET CANTIDAD = 24 WHERE ID_PRODUCTO = 2
UPDATE PRODUCTO SET CANTIDAD = 36 WHERE ID_PRODUCTO = 3

CREATE TRIGGER CAMBIO_CANTIDAD 
ON PRODUCTO
AFTER UPDATE 
AS 
BEGIN 
	UPDATE PRODUCTO SET CANTIDAD-(CANTIDAD/2)
	WHERE IDPRODUCTO IN (SELECT IDPRODUCTO FROM inserted)
	PRINT 'SE AJUSTO EL STOCK A LA MITAD'
END
GO