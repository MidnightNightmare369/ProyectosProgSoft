---CLASE 23/04/2025
---PUNTO TIPO PARCIAL: 
--DESARROLLAR UN PROCEDIMIENTO QUE PERMITA LLEVAR A UNA TABLA ADICIONAL EL SGTE PROCESO:
--EL TOTAL DE LAS MULTAS , MENOS LOS INGRESOS, MULTIPLICADOS POR EL CAMPO INHERENTE Y LUEGO
--SUMAR EL PROMEDIO DE LAS PERDIDAS DE LOS USUARIOS

--PASO 1 - CREACION DE VISTA
ALTER VIEW DATOS_USUARIOS2
AS
SELECT TOP 3000 dbo.USUARIOS.NOMBRE AS NOMBRE_USUARIO,
dbo.IMPACTO.MULTAS, dbo.IMPACTO.INGRESOS, dbo.IMPACTO.INHERENTE, dbo.PERDIDAS.VALORPERDIDA, 
TOTAL_VALORES = ((MULTAS - INGRESOS) * INHERENTE) + AVG(VALORPERDIDA)
FROM dbo.EVALUACION
INNER JOIN dbo.RIESGOS ON dbo.EVALUACION.IDRIESGO = dbo.RIESGOS.IDRIESGO
INNER JOIN dbo.IMPACTO ON dbo.RIESGOS.IDIMPACTO = dbo.IMPACTO.IDIMPACTO
INNER JOIN dbo.PERDIDAS ON dbo.RIESGOS.IDRIESGO = dbo.PERDIDAS.IDRIESGO
INNER JOIN dbo.USUARIOS ON dbo.EVALUACION.IDUSUARIO = dbo.USUARIOS.IDUSUARIO
GROUP BY USUARIOS.NOMBRE, MULTAS, INGRESOS, INHERENTE,VALORPERDIDA


--PASO 2 CREAR LA TABLA
IF NOT EXISTS (SELECT * FROM sys.sysobjects 
WHERE name = 'PERDIDAS_USUARIO' AND xtype = 'u')
CREATE TABLE  PERDIDAS_USUARIO(
NOMBRE_USUARIO NVARCHAR (255),
MULTAS FLOAT,
INGRESOS FLOAT,
INHERENTE FLOAT,
VALOR_PERDIDA FLOAT,
TOTAL_VALORES MONEY);

--PASO 3 CARGAR LA TABLA 
INSERT INTO PERDIDAS_USUARIO
SELECT * FROM DATOS_USUARIOS2

SELECT * FROM PERDIDAS_USUARIO

SELECT COLUMN_NAME, DATA_TYPE
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME IN ('IMPACTO', 'PERDIDAS')

---EJERCICICIO 2
--PARA EL AREA DE BANCOLOMBIA DESCONTAR UN 10%, PARA PANAMA UN 15% Y PARA CAYMAN 12%, AL FINALIZAR CREAR UN PROCEDIMIENTO ALMACENADO
--QUE EJECUTE DICHO DESCUENTO A TODOS LOS VALORES (CONDICIONAL ANIDADO)

--PASO 1 CREAR LA FUNCION

CREATE PROCEDURE PERDIDAS_VALORES 
(@AREA NVARCHAR (255), @VALOR_PER FLOAT, @TOTAL_PER FLOAT)
AS 
BEGIN 
  IF @AREA = 'BANCOLOMBIA'
     SET @TOTAL_PER = @VALOR_PER * 0.90 ---OR 1.10
	  ELSE  
	   IF @AREA = 'PANAMA'
         SET @TOTAL_PER = @VALOR_PER * 0.85 ---OR 1.15
		  ELSE 
		   IF @AREA = 'CAYMAN'
             SET @TOTAL_PER = @VALOR_PER * 0.88 ---OR 1.10

    SELECT @TOTAL_PER AS 'NUEVO_VALOR_DE_PERDIDAS: '
 END
GO

--EJECUCION MANUAL
EXEC PERDIDAS_VALORES @AREA = 'BANCOLOMBIA', @VALOR_PER = 346800, @TOTAL_PER = '';


-- LA DIFERENCIA ENTRE UN PROCEDURE Y UNA FUNCTION ES: LA FUNCTION RETORNA UN VALOR Y EL PROCEDURE UNA TABLA